[TOC]


硬盘分区表的结构：
============================
GPT(GUID Partition Table，缩写：GPT)
--------------------------------------------------

它是EFI(可扩展固件接口标准)的一部分,它可以创建两个隐藏分区，ESP和MSR。
ESP是efi系统分区用于保存引导文件，MSR是微软的保留分区。

ESP分区：EFI system partition，该分区用于采用了EFI BIOS的电脑系统，用来启动操作系统。分区内存放引导管理程序、驱动程序、系统维护工具等。

这种分区格式理论上分区数没有上限，


MBR(Master Boot Record，缩写：MBR)
--------------------------------------------------
它仅仅包含一个64个字节的硬盘分区表，由于每个分区信息需要16个字节，所以对于采用MBR型分区结构的硬盘，最多只能识别4个主要分区，所有对于这种结构的硬盘想要获得4个以上主要分区是不可能的。

扩展分区也是主分区（Primary partition）的一种，但它与主分区的不同在于理论上可以划分为无数个逻辑分区，每一个逻辑分区都有一个和MBR结构类似的扩展引导记录(EBR)。在MBR分区表中最多4个主分区或者3个主分区＋1个扩展分区，也就是说扩展分区只能有一个，然后可以再细分为多个逻辑分区。


不同硬盘分区表结构的启动模式
-------------------------------------------------
| 分区结构   | 启动模式   | 
| --------   | -----: | 
| MBR     | Legacy |  
| GPT        |   UEFI  | 

如何查看自己硬盘分区结构
-----------------------------------------
WIN8以上系统:   `Win+R` 输入msinfo32,回车查看系统信息，在`BIOS模式`一栏中可查看
其他版本：`C:\Windows\Panther`文件夹中找到`setupact.log`文件，用记事本打开，然后搜索`Detected Boot Environment`

BIOS 与 UEFI BIOS
==================================================================
定义
----------------------------
这两者都是计算机固件，是写在计算机主板内ROM芯片的程序
二者是并列关系，但UEFI BIOS相比BIOS要先进许多，作为BIOS的替代方案。

BIOS其主要功能是为计算机提供最底层的、最直接的硬件设置和控制。

启动流程([张怀良](https://www.zhihu.com/question/21672895/answer/45616136))
--------------------------------------------------

###BIOS
 
 1. 系统开机 - 上电自检（Power On Self Test 或 POST）。
 2. POST过后初始化用于启动的硬件（磁盘、键盘控制器等）。
 3. BIOS会运行BIOS磁盘启动顺序中第一个磁盘的首440bytes（MBR启动代码区域）内的代码。
 4. 启动引导代码从BIOS获得控制权，然后引导启动下一阶段的代码（一般是系统的启动引导代码）。
 5. 再次被启动的代码（二阶段代码）（即启动引导）会查阅支持和配置文件。
 6. 根据配置文件中的信息，启动引导程序会将内核和initramfs文件载入系统的RAM中，然后开始启动内核
 

###UEFI

 1. 系统开机 - 上电自检（Power On Self Test 或 POST）。
 2. UEFI -固件被加载，并由它初始化启动要用的硬件。
 3. 固件读取其引导管理器以确定从何处（比如，从哪个硬盘及分区）加载哪个 UEFI 应用。
 4. 固件按照引导管理器中的启动项目，加载UEFI 应用。
 5. 已启动的 UEFI 应用还可以启动其他应用。

ESP分区文件
====================================

一般按照官方的说明安装系统，会把一些必要的启动文件(包括efi文件)放到ESP分区的某个目录下，把启动文件信息写入UEFI启动菜单

`EFI/Microsoft`包含了windows系统引导启动的所有信息，非常重要，文件夹是字体和语言部分，BCD包含了windows引导开始以后的信息


`bootx64.efi` 是计算机默认引导文件
`bootmgfw.efi` 是 Windows默认引导文件

安装rEFind UEFI启动管理器
==================================================

关于快速启动
-------------------------------------------------

“快速启动” 是 Windows 8 时代引进的新特性，快速启动会关闭用户会话，但不再关闭内核会话，而是将其休眠。将部分系统数据以低电压载入内存，开机时直接从内存读取，从而提高系统启动速度，但可能会影响引导程序。

在电源选项中可以关闭快速启动。

关于安全启动
-------------------------------------------------
UEFI 有 “安全启动” 这个特点，引导程序只会启动那些得到 UEFI 固件签署的引导装载程序。此安全功能可以防止 Rootkit 类的恶意软件，并提供了额外的安全层。但它有一个缺点，如果你想在 Win 10 的电脑上双引导 Linux ，安全机制会阻止这样做。

可以在 UEFI 设置来禁用安全启动。
进入UEFI 工具界面(类似BIOS) > 
Boot(启动选项卡) >
Security >
Secure Boot(安全引导) > 保存并退出。

注意：不同品牌电脑 UEFI 界面会有差异。

安装rEFind 
------------------------------------------------------------
rEFInd是一个UEFI启动管理器，被设计为平台无关，可启动多个操作系统。
###Linux：
&emsp;下载rEFind压缩文件,解压文件，进入目录，sudo bash refind-install
&emsp;实际上，脚本做了这几件事：
&emsp;&emsp;读取你的计算机类型，选出对应的文件
&emsp;&emsp;在正确的目录放入或创建对应的文件
&emsp;&emsp;写入UEFI启动菜单
&emsp;如果脚本安装不成功，可以自行手动安装。
###Windows：
&emsp;挂载ESP系统分区，进入EFI文件夹，把rEFind文件解压到本目录，refind目录中会包含多余的文件，你可以根据你的计算机类型自行删除。
&emsp;refind.conf-sample是配置文件例子，里面的 `#` 是注释，需要新建一个配置文件(名为：refind.conf )，空的也可以，因为rEFind默认配置是在程序里的。
&emsp;把rEFInd手动添加到UEFI启动菜单里，种操作系统都有自己的工具。


配置文件详解可以参考[官方文档](http://www.rodsbooks.com/refind/configfile.html)

问题
----------------------
我的系统WIN10，在安装rEFind后，修改系统启动菜单时，怎么修改都无效，重启后又恢复成初始顺序。
根据文章ESP分区文件的说明，可以这样解决：

把原本`Microsoft`文件夹下内容移至EFI目录随便新建一个文件夹，例如我的叫`win10`，进入里面的Boot目录，全选所有的文件，拷贝到win10中来，删除掉win中的这个空的Boot目录。
`Microsoft\boot` 文件夹有个名为`bootmgfw.efi`，这是Windows的引导文件，rEFind中名为`refind_x64.efi`，这是rEFind引导文件。

我们可以将rEFind文件夹中`refind_x64.efi`引导文件名改为WIN10的引导文件名`bootmgfw.efi`,然后把rEFind移动至`Microsoft\boot`目录下。

最后配置好rEFind的配置文件，就可以了。

**注意**：操作前自行备份ESP分区文件。

使用的工具
========================================
DiskGenius
------------------------------
非权威人士，本文仅供参考.












